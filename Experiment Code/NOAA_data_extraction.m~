clear; clc
%% Format and process annual temperature data from NOAA

cityNames = {'Spokane WA', 'Boulder CO', 'Versailles KY', 'Owls Head ME', 'Austin TX'};


sheet = cityNames{4};
dataPath = 'G:\My Drive\Jeanne Lab\NOAA data\2021 SubHourly Environmental Data.xlsx';
data = readmatrix(dataPath,'Sheet', sheet);
time = data(:,3);
temp = data(:,9);
day = data(:,2);

% Temp data pull:
loc = temp>100 | temp<-50;
temp(loc) = nan;


% find the month timepoints
dayStart = find(time==5);
fiveminrate = (diff(temp))/5;
outliers = fiveminrate>30 | fiveminrate<-30;
exOut = fiveminrate(outliers);
fiveminrate(outliers) = nan;
DaysPerMonth = [1 31 28 31 30 31 30 31 31 30 31 30];
MonthStart = dayStart(cumsum(DaysPerMonth));
monthNames = {'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'};
% Planned temp rate changes
slow_rate = [0.1,-0.1];
mid_rate = [0.25, -0.25];
high_rate = [0.5, -0.5];

% PLOT FIGS
nrows = 3;
ncols = 4;
sb(1).idx = 1:3;
sb(2).idx = [5:7,9:11];
sb(3).idx = [4,8,12];

fig = figure; set(fig, 'pos',[285 382 955 596])
% Temp rate histogram
subplot(nrows, ncols, sb(2).idx)
h = histogram(fiveminrate);
h.EdgeColor = Color('grey');
set(gca, 'YScale', 'log')
ylabel('Count (five minute periods)')
xlabel('\DeltaT (\circC/min)')
% v_line(slow_rate, 'Cyan','-',2)
% v_line(mid_rate, 'DarkViolet','-',2)
% v_line(high_rate, 'Orange','-',2)

% Temp rate by day
subplot(nrows, ncols, sb(1).idx)
plot(fiveminrate,'linewidth', 2, 'Color',Color('grey'))
set(gca,'XTick',MonthStart,'XTickLabel',monthNames)
ylabel('\DeltaT (\circC/min)')
title_str = [sheet ' 2021'];
title(title_str)
xlabel('Month')
axis tight
% h_line(slow_rate, 'Cyan','-',1)
% h_line(mid_rate, 'DarkViolet','-',1)
% h_line(high_rate, 'Orange','-',1)

% Yearly temp histogram
subplot(nrows, ncols, sb(3).idx)
yyaxis left
set(gca, 'YColor','k')
yyaxis right
h = histogram(temp,50);
h.EdgeColor = Color('teal');
h.FaceColor = Color('teal');
ylabel('Count (five minute periods)')
xlabel('Temp (\circC)')
fig = formatFig(fig, true,[nrows,ncols], sb);

save_figure(fig, ['G:\My Drive\Jeanne Lab\NOAA data\' title_str ' annual temp rate no lines'],'-png');

%% NOAA data column headers
% #    Name                           Units
% 1    WBANNO                         XXXXX
% 2    UTC_DATE                       YYYYMMDD
% 3    UTC_TIME                       HHmm
% 4    LST_DATE                       YYYYMMDD
% 5    LST_TIME                       HHmm
% 6    CRX_VN                         XXXXXX
% 7    LONGITUDE                      Decimal_degrees
% 8    LATITUDE                       Decimal_degrees
% 9    AIR_TEMPERATURE                Celsius
% 10   PRECIPITATION                  mm
% 11   SOLAR_RADIATION                W/m^2
% 12   SR_FLAG                        X
% 13   SURFACE_TEMPERATURE            Celsius
% 14   ST_TYPE                        X
% 15   ST_FLAG                        X
% 16   RELATIVE_HUMIDITY              %
% 17   RH_FLAG                        X
% 18   SOIL_MOISTURE_5                m^3/m^3
% 19   SOIL_TEMPERATURE_5             Celsius
% 20   WETNESS                        Ohms
% 21   WET_FLAG                       X
% 22   WIND_1_5                       m/s
% 23   WIND_FLAG                      X


%% Convert data from excel to .mat files
baseFolder = getCloudPath;  
rootdir = [baseFolder 'NOAA Data/'];
fileNames = {'AK', 'AL', 'AR', 'AZ', 'CA', 'CO', 'FL', 'GA', 'HI',...
             'IA', 'ID', 'IL', 'IN', 'KS', 'KY', 'LA', 'ME', 'MI', 'MN', 'MO', 'MS', 'MT',...
             'NC', 'ND', 'NE','NH','NM','NV','NY', 'OR','ON', 'OK', 'OH',...
             'PA','RI', 'SC', 'SD', 'TN', 'TX', 'UT', 'VA', 'WA', 'WI', 'WV', 'WY'};

for ii = 1:length(fileNames)
    fullPath = [rootdir '2021 ' fileNames{ii} ' SubHourly NOAA Data.xlsx'];
    sheets = sheetnames(fullPath);
    disp(ii)
    for sheet = 1:size(sheets,1)
        % Pull the longitude and latitude of each recording location:
        location = sheets{sheet};
        tic
        data = readmatrix(fullPath,'Sheet', location);
        toc
        save([rootdir location '.mat'],'data','location');
        clear data location
    end
end
beep

%% Pull data and start building structure

clear
baseFolder = getCloudPath;  
rootdir = [baseFolder 'NOAA Data/'];

% get list of files
list_dirs = dir([rootdir, '/*.mat']); %only matlab files
list_dirs = {list_dirs(:).name};
nCity = length(list_dirs);

% load data
[longitude, latitude, city_name] = deal([]);

for city = 1:nCity
    
    load([rootdir list_dirs{city}]);
    % log city name
    city_name{city} = location;
    
    % assign data
    longitude(city) = data(1,7);
    latitude(city) = data(1,8);
    cityData(city).T = data;
    
    clear location data
end
save([rootdir 'Processed Data/2021 Subhourly Data'],'-v7.3');

%% Plot geographical locations of all the cities in the data set

for ii = 1:nCity
    longitude(ii) = cityData(ii).T(1,7);
    latitude(ii) = cityData(ii).T(1,8);
end

fig = figure;
geoscatter(latitude, longitude, 36, Color('blue'),'filled','^')
geobasemap colorterrain
set(fig, 'color', 'k')
ax = gca;
set(ax, 'fontsize', 13, 'grid', 'off')
ax.LongitudeLabel.Color = 'w';
ax.LatitudeLabel.Color = 'w';
ax.LongitudeAxis.Color = 'w'; 
ax.LatitudeAxis.Color = 'w'; 

% ax.LongitudeLimits = [-175.3770 -62.7130];
% ax.LatitudeLimits = [18.2455 72.6145];

save_figure(fig,[rootdir 'Figures/Sample locations'],'-png');

%% ANALYSIS find the temp rates for each sampling location

X = linspace(-1.5,1.5,100);
[dataCDF, dataPDF] = deal([]);

for ii = 1 : nCity

    data = cityData(ii).T; % Select data for a particular city:
    if size(data,1)<105120
        dataPDF(:,ii) = nan(1,length(X));
        dataCDF(:,ii) = nan(1,length(X));
        [mu(ii),sigma(ii),annualT(ii)] = deal(nan);
        continue
    end
    % Extract data from structure
    day = data(:,4);
    time = data(:,5);
    temp = data(:,9);

    % Remove outliers:
    loc = temp>100 | temp<-50;
    temp(loc) = nan;
    % save avg annual temp
    annualT(ii) = mean(temp,'omitnan');

    % find the month timepoints
    dayStart = find(time==5);
    fiveminrate = (diff(temp))/5;
    outliers = fiveminrate>30 | fiveminrate<-30;
    exOut = fiveminrate(outliers);
    fiveminrate(outliers) = nan;
    cityData(ii).tempRate = fiveminrate;

    % Fit data
    mu(ii) = mean(fiveminrate,'omitnan');
    sigma(ii) = var(fiveminrate,'omitnan');
    gm = gmdistribution(mu(ii),sigma(ii));
    dataPDF(:,ii) = pdf(gm,X');
    dataCDF(:,ii) = cdf(gm,X');
    
    % Pull long / lat data again
    longitude = data(:,7);
    latitude = data(:,8);

end

%% FIGURE: temp over a year (single plot example)
minT = -90; % lowest recorded temperature on record
maxT = 57; %highest recorded temp on record

city = 106; %Old Town ME
data = cityData(city).T;
time = data(:,5);
surf_temp = data(:,13);
air_temp = data(:,9);

% clean data
loc = surf_temp<minT | surf_temp>maxT;
surf_temp(loc) = nan;
loc = air_temp<minT | air_temp>maxT;
air_temp(loc) = nan;

fig = figure;
plot(surf_temp,'linewidth', 2, 'Color',Color('teal'))
set(gca,'XTick',MonthStart,'XTickLabel',monthNames)
ylabel('Temperature (\circC)')
title_str = [city_name{city} ' 2021'];
title(title_str)
xlabel('Month')
axis tight
formatFig(fig,true);
set(gca, 'fontsize', 15)
save_figure(fig,[rootdir 'Figures/Annual temp in ' city_name{city}],'-png');

%% FIGURE: temp rate over a for a year (single plot example)

fig = figure;
plot(cityData(city).tempRate,'linewidth', 2, 'Color',Color('orangered'))
set(gca,'XTick',MonthStart,'XTickLabel',monthNames)
ylabel('\DeltaT (\circC/min)')
title_str = [city_name{city} ' 2021'];
title(title_str)
xlabel('Month')
axis tight

formatFig(fig,true);
set(gca, 'fontsize', 15)
save_figure(fig,[rootdir 'Figures/Annual temprate in ' city_name{city}],'-png');

%% FIGURE: temp rate histogram over a year
xMin = -0.5;
xMax = 0.5;
nbins = 400; 

fig = figure;
h = histogram(cityData(city).tempRate,nbins);
xlim([xMin,xMax])
h.FaceColor = 'w';
h.EdgeColor = 'w';
xlabel('\DeltaT (\circC/min)')
ylabel('Count')
title_str = [city_name{city} ' 2021'];
title(title_str)

formatFig(fig,true);
set(gca, 'fontsize', 15)
save_figure(fig,[rootdir 'Figures/Annual temprate histogram ' title_str],'-png');


% overlay the PDF fuction for this dataset:
X = linspace(xMin,xMax,100);
dist = gmdistribution(mu(city),sigma(city));
Y = pdf(dist,X');

fig = figure;
    h = histogram(cityData(city).tempRate,nbins);
    xlim([-0.5,0.5])
    h.FaceColor = 'w';
    h.EdgeColor = 'w';
    xlabel('\DeltaT (\circC/min)')
    ylabel('Count')
yyaxis right
    plot(X,Y,'color', Color('dodgerblue'),'linewidth', 2)
    ylabel('PDF')

formatFig(fig,true);
set(gca, 'fontsize', 15)
yyaxis left
set(gca, 'YColor', 'w')
yyaxis right
set(gca, 'YColor', Color('dodgerblue'))

save_figure(fig,[rootdir 'Figures/Annual temp-rate histogram with PDF ' title_str],'-png');

%% FIGURE: show city sample location on the map
fig = figure;
g = geoscatter(cityData(city).T(1,8), cityData(city).T(1,7), 75, Color('blue'),'filled','^');
geobasemap colorterrain
set(fig, 'color', 'k')
ax = gca;
set(ax, 'fontsize', 13, 'grid', 'off')
ax.LongitudeLabel.Color = 'w';
ax.LatitudeLabel.Color = 'w';
ax.LongitudeAxis.Color = 'w'; 
ax.LatitudeAxis.Color = 'w'; 
title(city_name{city},'color', 'w')
% 
% ax.LongitudeLimits = [-175.3770 -62.7130];
% ax.LatitudeLimits = [18.2455 72.6145];

save_figure(fig,[rootdir 'Figures/Sampling location for ' city_name{city}],'-png');

%% FIGURE: show all the PDFs for the different sampling locations

% Plot the distribution functions overlaid
fig = figure; hold on
for ii = 1:nCity
    plot(X, dataPDF(:,ii),'color', Color('grey'),'linewidth',1)
end
xlabel('\DeltaT (\circC/min)')
ylabel('PDF')
formatFig(fig, true);
set(gca, 'fontsize', 15)

save_figure(fig,[rootdir 'Figures/All locations temp-rate PDF'],'-png');

%% FIGURE: comparison of annual temp and temp rate variability across the US by latitude
latitude = [];
longitude = [];
for ii = 1:nCity
    latitude(ii) = cityData(ii).T(1,8);
    longitude(ii) = cityData(ii).T(1,7);
end

data = [annualT',sigma',latitude'];
data1 = sortrows(data,3);

% color points by latitude (N-S axis)
CList = Color('indigo','lavender', nCity);

fig = figure;
scatter(data1(:,1),data1(:,2),75,CList,'filled')
xlabel('average annual temperature (\circC)')
ylabel('temp rate variance')
formatFig(fig,true);
set(gca, 'fontsize', 18)

save_figure(fig,[rootdir 'Figures/Annual temp vs temp rate variance'],'-png');


fig = figure;
scatter(data1(:,3), data1(:,1), 75, CList, 'filled')
xlabel('Latitude (\circ)')
ylabel('average annual temperature (\circC)')
formatFig(fig,true);
set(gca, 'fontsize', 18)

save_figure(fig,[rootdir 'Figures/Annual temp vs latitude'],'-png');

%% FIGURE: temp tate outliers and their locations
loc = find(sigma>0.02);
lon = longitude(loc);
lat = latitude(loc);

fig = figure;
    g = geoscatter(latitude, longitude, 75, Color('blue'),'filled','^');
    hold on
    g = geoscatter(lat, lon, 75, Color('red'),'filled','^');
    geobasemap colorterrain
    set(fig, 'color', 'k')
    ax = gca;
    set(ax, 'fontsize', 13, 'grid', 'off')
    ax.LongitudeLabel.Color = 'w';
    ax.LatitudeLabel.Color = 'w';
    ax.LongitudeAxis.Color = 'w'; 
    ax.LatitudeAxis.Color = 'w'; 
    title('Temp rate outlier locations','color', 'w')

save_figure(fig,[rootdir 'Figures/Sampling location for temprate outliers'],'-png');

% scatter plot overlays with the outliers color coded
fig = figure;
hold on
scatter(data1(:,3), data1(:,1), 75, CList, 'filled')
scatter(latitude(loc), annualT(loc), 75, 'r', 'filled')
xlabel('Latitude (\circ)')
ylabel('average annual temperature (\circC)')
formatFig(fig,true);
set(gca, 'fontsize', 18)

save_figure(fig,[rootdir 'Figures/Annual temp vs latitude temprate outliers'],'-png');

fig = figure; hold on
scatter(data1(:,1),data1(:,2),75,CList,'filled')
scatter(annualT(loc), sigma(loc), 75, 'r', 'filled')
xlabel('average annual temperature (\circC)')
ylabel('temp rate variance')
formatFig(fig,true);
set(gca, 'fontsize', 18)

save_figure(fig,[rootdir 'Figures/Annual temp vs temp rate variance temprate outliers'],'-png');

%% How does morning temperature compare to expected light levels? (e.g time vs temp)

% find the 'morning' hours -- i.e. show am vs pm

time = cityData(city).T(:,5); % local solar time
temp = cityData(city).T(:,9); % air temp
tempRate = cityData(city).tempRate;
loc = temp>maxT | temp<minT; % find false temperatures
temp(loc) = nan; % remove temp anomalies

amLoc = find(time<1200); % hours in before noon
pmLoc = find(time>=1200); % hours after noon

% combine time and temp:
data = [time(1:end-1),temp(1:end-1),tempRate];
morningTemp = data(amLoc,:);
eveningTemp = data(pmLoc,:);

% pull out each day's time course:
amStarts = find(time==0);
pmStarts = find(time==1200);

if amStarts(1)<pmStarts(1)
    for ii = 1:364
        T.time(:,ii) = data(amStarts(ii):pmStarts(ii),1);
        T.temp(:,ii) = data(amStarts(ii):pmStarts(ii),2);
        T.tempR(:,ii) = data(amStarts(ii):pmStarts(ii),3);
    end
end

% check individual patterns
for ii = 160:170
    
x = T.time(:,ii);
x = find(rem(x,100)==0); % pull hour start times
row = 2; col = 1;
fig = figure; 
    subplot(row,col,1)
        plot(T.tempR(:,ii),'color', 'w','linewidth', 1.5)
        axis tight
        hline(0)
        ax = gca;
        set(ax, 'XTick',x,'XTickLabels',T.time(x,ii)/100)
        xlabel('Time (hr)')
        ylabel('\DeltaT (\circC/min)')
    subplot(row,col,2)
        plot(T.temp(:,ii),'color', 'w','linewidth', 1.5)
        axis tight
        ax = gca;
        set(ax, 'XTick',x,'XTickLabels',T.time(x,ii)/100)
        xlabel('Time (hr)')
        ylabel('Temperature (\circC)')
formatFig(fig,true, [row,col]);
end

save_figure(fig,[rootdir 'Figures/Morning temperature ' city_name{city} ' day ' num2str(ii)],'-png');


% Overlay multiple days in one plot
plotList = [160:2:169];
CList = Color('orange', 'teal',length(plotList));

x = T.time(:,plotList(1));
x = find(rem(x,100)==0); % pull hour start times
row = 2; col = 1;
fig = figure; 
idx = 0;
for ii = plotList
    idx = idx+1;
    subplot(row,col,1)
    hold on
        plot(T.tempR(:,ii),'color', CList(idx,:),'linewidth', 1.5)
    subplot(row,col,2)
    hold on
        plot(T.temp(:,ii),'color', CList(idx,:),'linewidth', 1.5)
    lStr{idx} = num2str(ii);
end
% formatting:
 subplot(row,col,1)
        axis tight
        hline(0)
        ax = gca;
        set(ax, 'XTick',x,'XTickLabels',T.time(x,ii)/100)
        xlabel('Time (hr)')
        ylabel('\DeltaT (\circC/min)')
    subplot(row,col,2)
        axis tight
        ax = gca;
        set(ax, 'XTick',x,'XTickLabels',T.time(x,ii)/100)
        xlabel('Time (hr)')
        ylabel('Temperature (\circC)')
formatFig(fig,true, [row,col]);
legend(lStr,'textcolor', 'w','box', 'off')

save_figure(fig,[rootdir 'Figures/Morning temperature ' city_name{city} ' temp drops'],'-png');



